# üèóÔ∏è Architecture Projet - Planning Boulangerie

## üìã **Vue d'ensemble**
Application web compl√®te pour la gestion du planning d'une boulangerie avec syst√®me d'absences int√©gr√©.

---

## üèõÔ∏è **Architecture Technique**

### **Frontend (React)**
- **Framework** : React 18 avec React Router v6
- **UI** : React Bootstrap + CSS personnalis√©
- **HTTP Client** : Axios avec timeout 60s
- **Notifications** : React-Toastify
- **Build** : Create React App
- **URL Base** : `/plan/` (pour OVH)

### **Backend (Node.js/Express)**
- **Framework** : Express.js
- **Base de donn√©es** : MongoDB Atlas (cloud)
- **ORM** : Mongoose
- **D√©ploiement** : Render.com (PaaS)
- **CORS** : Configur√© pour OVH et Render
- **S√©curit√©** : Helmet, compression

### **Base de donn√©es (MongoDB Atlas)**
- **Statut** : ‚úÖ RESTAUR√â
- **Collections** : employees, constraints, planning, absences, equity_stats
- **Indexes** : Optimis√©s pour les requ√™tes fr√©quentes
- **Backup** : Automatique (Atlas)

---

## üåê **Environnements de D√©ploiement**

### **Production**
- **Frontend** : OVH (https://www.filmara.fr/plan/)
- **Backend** : Render (https://boulangerie-planning-api-3.onrender.com)
- **Base de donn√©es** : MongoDB Atlas

### **D√©veloppement**
- **Frontend** : localhost:3000
- **Backend** : localhost:5000
- **Base de donn√©es** : MongoDB Atlas (m√™me instance)

---

## üéØ **INT√âGRATION GOOGLE OR-TOOLS**

### **Architecture OR-Tools**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP POST    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Node.js API         ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ   Python OR-Tools API   ‚îÇ
‚îÇ   (boulangerie-api)     ‚îÇ                 ‚îÇ  (planning-ortools-api)  ‚îÇ
‚îÇ                         ‚îÇ                 ‚îÇ                         ‚îÇ
‚îÇ ‚Ä¢ Pr√©pare les donn√©es   ‚îÇ                 ‚îÇ ‚Ä¢ R√©solution OR-Tools    ‚îÇ
‚îÇ ‚Ä¢ Appelle l'API         ‚îÇ                 ‚îÇ ‚Ä¢ Contraintes strictes   ‚îÇ
‚îÇ ‚Ä¢ Traite la r√©ponse     ‚îÇ                 ‚îÇ ‚Ä¢ Optimisation ¬±0.5h     ‚îÇ
‚îÇ ‚Ä¢ Fallback si √©chec     ‚îÇ                 ‚îÇ ‚Ä¢ Multi-crit√®res         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ Render                                    ‚îÇ Render
         ‚îÇ (principal)                               ‚îÇ (service s√©par√©)
```

### **üîß Configuration**
- **URL API OR-Tools** : `https://planning-ortools-api.onrender.com/solve`
- **Variable d'environnement** : `ORTOOLS_API_URL`
- **Timeout** : 60 secondes
- **Fallback** : M√©thode classique si OR-Tools indisponible

### **üì° Flux de donn√©es**
```json
// Donn√©es envoy√©es √† OR-Tools
{
  "employees": [
    {
      "id": "employeeId",
      "name": "Nom Employ√©",
      "volume": 35,
      "status": "Majeur|Mineur",
      "contract": "CDI|Apprentissage",
      "skills": ["Ouverture", "Fermeture"],
      "function": "Vendeuse|Manager|Responsable"
    }
  ],
  "constraints": {
    "employeeId": {
      "0": "CP",     // Lundi
      "1": "MAL",    // Mardi
      "6": "Repos"   // Dimanche
    }
  },
  "affluences": [2, 2, 2, 3, 3, 4, 2],  // Lun-Dim
  "week_number": 36
}
```

```json
// R√©ponse d'OR-Tools
{
  "success": true,
  "planning": {
    "employeeId": {
      "0": "06h00-14h00",    // Lundi
      "1": "Repos",          // Mardi
      "2": "13h00-20h30",    // Mercredi
      "3": "07h30-15h30",    // Jeudi
      "4": "Repos",          // Vendredi
      "5": "06h00-16h30",    // Samedi
      "6": "Repos"           // Dimanche
    }
  },
  "validation": {
    "warnings": ["Alice: 35.5h au lieu de 35h (√©cart +0.5h)"],
    "stats": {
      "total_hours": 280,
      "diagnostic": [],
      "suggestions": []
    }
  },
  "solver_info": {
    "status": "OPTIMAL",
    "solve_time": 2.34,
    "objective": 15
  }
}
```

### **‚öôÔ∏è Contraintes OR-Tools**

#### **1. Volume horaire STRICT**
- **Tol√©rance** : ¬±0.5h (au lieu de ¬±2h)
- **Objectif** : Respecter exactement les heures contractuelles
- **Poids** : 20x (priorit√© maximale)

#### **2. Contraintes d'ouverture**
```python
# Exactement 1 personne √† l'ouverture (comp√©tence requise)
for day in range(7):
    opening_vars = []
    for emp in employees:
        if 'Ouverture' in emp.skills:
            for slot in shifts[emp_id][day]:
                if slot.startswith('06h00'):
                    opening_vars.append(shifts[emp_id][day][slot])
    
    model.Add(sum(opening_vars) == 1)
```

#### **3. Contraintes de fermeture**
```python
# Au moins 1 personne avec comp√©tence fermeture
for day in range(7):
    closing_vars_skilled = []
    for emp in employees:
        if 'Fermeture' in emp.skills:
            for slot in shifts[emp_id][day]:
                if '20h30' in slot:
                    closing_vars_skilled.append(shifts[emp_id][day][slot])
    
    model.Add(sum(closing_vars_skilled) >= 1)
```

#### **4. R√®gles mineurs**
```python
# Repos dimanche obligatoire + max 35h
for emp in employees:
    if emp.status == 'Mineur':
        model.Add(shifts[emp_id][6]['Repos'] == 1)  # Dimanche
        
        total_hours = []
        for day in range(7):
            for slot, var in shifts[emp_id][day].items():
                hours = int(slot_hours[slot] * 10)
                total_hours.append(var * hours)
        
        model.Add(sum(total_hours) <= 350)  # 35h max
```

#### **5. Repos obligatoires**
```python
# 2 repos minimum pour temps pleins (‚â•35h)
for emp in employees:
    rest_count = []
    for day in range(7):
        if 'Repos' in shifts[emp_id][day]:
            rest_count.append(shifts[emp_id][day]['Repos'])
    
    if emp.volume >= 35:
        model.Add(sum(rest_count) >= 2)
```

### **üéØ Objectif multi-crit√®res**
```python
# Priorit√© 1: Respecter volumes horaires (poids 20x)
for emp in employees:
    gap_pos = model.NewIntVar(0, 100, f'gap_pos_{emp_id}')
    gap_neg = model.NewIntVar(0, 100, f'gap_neg_{emp_id}')
    
    model.Add(total_hours + gap_neg - gap_pos == target_hours)
    objectives.append(20 * (gap_pos + gap_neg))

# Objectif global : minimiser √©carts
model.Minimize(sum(objectives))
```

### **üìä Cr√©neaux disponibles**

#### **Semaine (Lundi-Vendredi)**
```python
base_slots = [
    'Repos',
    '06h00-14h00',    # 8.0h - Ouverture standard
    '07h30-15h30',    # 8.0h - Support matin
    '13h00-20h30',    # 7.5h - Fermeture
]

# Si affluence >= 2
if affluence_level >= 2:
    base_slots.extend([
        '10h00-18h00',    # 8.0h - Renfort midi
        '14h00-20h30',    # 6.5h - Renfort fermeture
    ])

# Si affluence >= 3
if affluence_level >= 3:
    base_slots.extend([
        '09h00-17h00',    # 8.0h - Renfort matin√©e
        '16h00-20h30',    # 4.5h - Support fermeture courte
    ])
```

#### **Samedi**
```python
samedi_slots = [
    'Repos',
    '06h00-16h30',    # 10.5h - Ouverture longue
    '07h30-16h30',    # 9.0h - Support matin
    '10h30-16h30',    # 6.0h - Renfort midi
    '16h30-20h30',    # 4.0h - Fermeture
    '17h00-20h30',    # 3.5h - Support fermeture
]
```

#### **Dimanche**
```python
dimanche_slots = [
    'Repos',
    '06h00-13h00',    # 7.0h - Ouverture matin
    '07h30-13h00',    # 5.5h - Support matin  
    '09h30-13h00',    # 3.5h - Renfort matin
    '13h00-20h30',    # 7.5h - Fermeture apr√®s-midi
    '14h00-20h30',    # 6.5h - Support fermeture
]
```

### **üîÑ Fallback et robustesse**
```javascript
// Dans planningController.js
try {
  // Appel OR-Tools
  const result = await this.callORToolsAPI(data);
  
  if (result.success) {
    console.log('‚úÖ Solution trouv√©e avec OR-Tools !');
    return this.createPlanningsFromORToolsSolution(result.planning, weekNumber, year, employees);
  } else {
    console.log('‚ö†Ô∏è OR-Tools a √©chou√©, fallback vers m√©thode classique...');
    return this.generateWeeklyPlanningClassic(weekNumber, year, affluenceLevels, employees);
  }
} catch (error) {
  console.error('‚ùå Erreur avec OR-Tools:', error);
  return this.generateWeeklyPlanningClassic(weekNumber, year, affluenceLevels, employees);
}
```

### **üìà Am√©lioration des performances**
- **Pr√©cision** : ¬±0.5h au lieu de ¬±2h
- **Contraintes strictes** : Respect exact des comp√©tences
- **Optimisation** : Multi-crit√®res avec pond√©ration
- **Robustesse** : Fallback automatique
- **Rapidit√©** : R√©solution en ~2-5 secondes

### **üöÄ D√©ploiement de l'API OR-Tools**

#### **1. Cr√©ation du repository GitHub**
```bash
# Repository cr√©√© : https://github.com/Philippe-62000/planning-ortools-api
# Fichiers n√©cessaires :
- ortools-api.py          # API Flask avec OR-Tools
- requirements.txt        # D√©pendances Python
- render.yaml            # Configuration Render
- README.md              # Documentation
```

#### **2. Fichiers de d√©ploiement**

**üìÑ requirements.txt**
```
Flask==2.3.3
Flask-CORS==4.0.0
ortools==9.14.6206       # Version corrig√©e (9.7.2996 n'existait pas)
gunicorn==21.2.0
```

**üìÑ render.yaml**
```yaml
services:
  - type: web
    name: planning-ortools-api
    env: python
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn --bind 0.0.0.0:$PORT ortools-api:app
    envVars:
      - key: FLASK_ENV
        value: production
      - key: PORT
        value: 10000
    healthCheckPath: /
    autoDeploy: true
```

#### **3. D√©ploiement sur Render**
1. **Service cr√©√©** : `planning-ortools-api`
2. **URL d√©ploy√©e** : `https://planning-ortools-api.onrender.com`
3. **Status** : ‚úÖ Online (test√© avec health check)
4. **Build temps** : ~5-10 minutes (OR-Tools = 27.7 MB)

#### **4. Configuration API principale**

**Variable d'environnement ajout√©e :**
```bash
# Dans boulangerie-planning-api (Render Dashboard ‚Üí Environment)
ORTOOLS_API_URL = "https://planning-ortools-api.onrender.com/solve"
```

**Test de connectivit√© :**
```json
# GET https://planning-ortools-api.onrender.com/
{
  "status": "online",
  "service": "Planning Boulangerie OR-Tools API", 
  "version": "5.0",
  "timestamp": "2025-09-01T21:59:21.618600",
  "endpoints": {
    "status": "GET /",
    "solve": "POST /solve"
  }
}
```

#### **5. Architecture finale d√©ploy√©e**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           PRODUCTION RENDER             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ     API Principale              ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ boulangerie-planning-api        ‚îÇ    ‚îÇ 
‚îÇ  ‚îÇ                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Node.js + Express + MongoDB     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ URL: /api/planning/generate     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ ENV: ORTOOLS_API_URL            ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                ‚îÇ HTTP POST              ‚îÇ
‚îÇ                ‚ñº                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ     API OR-Tools                ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ planning-ortools-api            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Python + Flask + OR-Tools       ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ URL: /solve                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Optimisation ¬±0.5h              ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **6. Flux de donn√©es en production**
```javascript
// 1. Utilisateur g√©n√®re planning
POST /api/planning/generate

// 2. API principale pr√©pare donn√©es
const employeesData = employees.map(emp => ({
  id: emp._id.toString(),
  name: emp.name,
  volume: emp.weeklyHours,
  status: emp.age < 18 ? 'Mineur' : 'Majeur',
  skills: emp.skills || [],
  function: emp.role || 'Vendeuse'
}));

// 3. Appel API OR-Tools
const response = await fetch('https://planning-ortools-api.onrender.com/solve', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    employees: employeesData,
    constraints: constraints,
    affluences: affluences,
    week_number: weekNumber
  })
});

// 4. Traitement r√©ponse OR-Tools
if (result.success) {
  // Utiliser solution optimis√©e OR-Tools
  return this.createPlanningsFromORToolsSolution(result.planning);
} else {
  // Fallback m√©thode classique
  return this.generateWeeklyPlanningClassic();
}
```

#### **7. Monitoring et sant√©**

**Health checks disponibles :**
- **API OR-Tools** : `GET https://planning-ortools-api.onrender.com/`
- **API Principale** : `GET https://boulangerie-planning-api-3.onrender.com/health`

**Logs de d√©ploiement :**
```bash
# OR-Tools API
‚úÖ Successfully installed ortools-9.14.6206
‚úÖ Build successful üéâ
‚úÖ Running 'gunicorn app:app --bind 0.0.0.0:$PORT'
‚úÖ Your service is live üéâ

# API Principale (apr√®s configuration)
‚úÖ ORTOOLS_API_URL configured
‚úÖ OR-Tools integration active
‚úÖ Fallback method available
```

#### **8. Troubleshooting d√©ploiement**

**Probl√®mes rencontr√©s et solutions :**

1. **Version OR-Tools invalide** ‚ùå
   ```bash
   ERROR: Could not find a version that satisfies the requirement ortools==9.7.2996
   ```
   **Solution** ‚úÖ : Mise √† jour vers `ortools==9.14.6206`

2. **Cold start Render** ‚ö†Ô∏è
   - OR-Tools peut √™tre lent au premier d√©marrage
   - Render met les services en veille apr√®s inactivit√©
   - **Solution** : Pinging automatique ou upgrade plan

3. **Timeout API OR-Tools** ‚ö†Ô∏è
   - Timeout configur√© √† 60 secondes
   - **Solution** : Fallback automatique vers m√©thode classique

#### **9. Performance en production**

**M√©triques attendues :**
- **Temps r√©solution OR-Tools** : 2-5 secondes
- **Pr√©cision horaire** : ¬±0.5h (vs ¬±2h avant)
- **Taux de r√©ussite OR-Tools** : ~95%
- **Taux de fallback** : ~5% (cas complexes)

**Avantages d√©ploy√©s :**
- ‚úÖ Contraintes strictes respect√©es
- ‚úÖ Optimisation multi-crit√®res
- ‚úÖ Respect exact comp√©tences ouverture/fermeture
- ‚úÖ R√®gles mineurs appliqu√©es
- ‚úÖ Rotation automatique des horaires

#### **10. üêõ Correction critique v1.4.1**

**Probl√®me d√©tect√© le 19/12/2024 :**
```
‚ùå Planning g√©n√©r√© avec violations majeures :
- Ana√Øs: 42h au lieu de 35h (+7h)
- Vanessa F: 40h au lieu de 39h (+1h) 
- Severine: 46.5h au lieu de 39h (+7.5h)
- Volumes horaires non respect√©s
- OR-Tools non utilis√©
```

**Diagnostic :**
```javascript
// PROBL√àME : M√©thodes dupliqu√©es dans planningController.js

// ‚úÖ M√©thode correcte (ligne 570)
async generateWeeklyPlanning(weekNumber, year, affluenceLevels, employees) {
  console.log('üöÄ G√©n√©ration planning avec Google OR-Tools...');
  const result = await this.callORToolsAPI({...});  // ‚Üê API externe
}

// ‚ùå M√©thode obsol√®te (ligne 923) - UTILIS√âE PAR ERREUR
async generateWeeklyPlanning(weekNumber, year, affluenceLevels, employees) {
  const orToolsSolution = this.optimizePlanningWithORTools(...);  // ‚Üê N'existe plus !
  return this.generateWeeklyPlanningClassic(...);  // ‚Üê Fallback permanent
}
```

**Cause racine :**
- **Code dupliqu√©** : 2 m√©thodes `generateWeeklyPlanning` dans le m√™me fichier
- **R√©f√©rence cass√©e** : Ancienne m√©thode appelait `optimizePlanningWithORTools` (supprim√©e)
- **Fallback permanent** : Toujours la m√©thode classique utilis√©e
- **OR-Tools ignor√©** : API externe jamais appel√©e

**Solution appliqu√©e v1.4.1 :**
```diff
// Suppression m√©thodes obsol√®tes
- async generateWeeklyPlanning() { // Ligne 923 - SUPPRIM√âE
-   const orToolsSolution = this.optimizePlanningWithORTools(...);
-   return this.generateWeeklyPlanningClassic(...);
- }

- createPlanningsFromSolution(solution, weekNumber, year) { // SUPPRIM√âE
-   // Ancienne logique OR-Tools locale
- }

// Conservation m√©thode correcte
+ async generateWeeklyPlanning() { // Ligne 570 - CONSERV√âE
+   console.log('üöÄ G√©n√©ration planning avec Google OR-Tools...');
+   const result = await this.callORToolsAPI({...});  // ‚Üê API externe
+ }

// Ajout logs debug
+ console.log('üìä Donn√©es re√ßues:', { 
+   weekNumber, employeesCount, ortoolsUrl: process.env.ORTOOLS_API_URL 
+ });
+ console.log('üì° Donn√©es pr√©par√©es pour OR-Tools:', {...});
+ console.log('üìà R√©sultat OR-Tools:', { success, hasPlanning, error });
```

**V√©rification post-correction :**
```bash
# Logs attendus apr√®s v1.4.1
üöÄ G√©n√©ration planning avec Google OR-Tools...
üìä Donn√©es re√ßues: { weekNumber: 36, employeesCount: 9, ortoolsUrl: "https://planning-ortools-api.onrender.com/solve" }
üì° Donn√©es pr√©par√©es pour OR-Tools: { employeesData: 9, constraints: 0, affluences: [2,2,2,2,2,2,2] }
üì° Appel API OR-Tools: https://planning-ortools-api.onrender.com/solve
üìä R√©ponse OR-Tools: ‚úÖ Succ√®s
üìà R√©sultat OR-Tools: { success: true, hasPlanning: true, error: "Aucune erreur" }
‚úÖ Solution trouv√©e avec OR-Tools !
```

**Impact de la correction :**
- ‚úÖ **OR-Tools utilis√©** : API externe appel√©e correctement
- ‚úÖ **Pr√©cision horaire** : ¬±0.5h respect√©e
- ‚úÖ **Contraintes strictes** : Volumes, ouverture, fermeture, mineurs
- ‚úÖ **Tra√ßabilit√©** : Logs d√©taill√©s pour debugging
- ‚úÖ **Fallback s√©curis√©** : M√©thode classique si OR-Tools √©choue

**Pr√©vention future :**
- üîç **Code review** : √âviter duplication de m√©thodes
- üìä **Tests automatis√©s** : V√©rifier utilisation OR-Tools
- üìã **Logs structur√©s** : Tra√ßabilit√© compl√®te du processus
- ‚ö†Ô∏è **Alertes** : Monitoring volumes horaires d√©viants

---

## üìÅ **Structure des Fichiers**

```
boulangerie-planning/
‚îú‚îÄ‚îÄ frontend/                    # Application React
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/         # Composants r√©utilisables
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeModal.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SickLeaveModal.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AbsenceModal.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/             # Pages principales
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Employees.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Constraints.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PlanningGenerator.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AbsenceStats.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api.js         # Configuration Axios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ App.js
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ backend/                    # API Node.js/Express
‚îÇ   ‚îú‚îÄ‚îÄ models/                # Sch√©mas Mongoose
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Employee.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WeeklyConstraints.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Planning.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Absence.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EquityStats.js
‚îÇ   ‚îú‚îÄ‚îÄ controllers/           # Logique m√©tier
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employeeController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ planningController.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constraintController.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ absenceController.js
‚îÇ   ‚îú‚îÄ‚îÄ routes/               # Routes API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employees.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ planning.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constraints.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ absences.js
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.js         # Dev
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config-production.js
‚îÇ   ‚îú‚îÄ‚îÄ server.js
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ deploy/                   # Fichiers de d√©ploiement
‚îÇ   ‚îú‚îÄ‚îÄ www/                 # Frontend build (OVH)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .htaccess
‚îÇ   ‚îî‚îÄ‚îÄ api/                 # Backend (OVH - obsol√®te)
‚îú‚îÄ‚îÄ scripts/                 # Scripts de d√©ploiement
‚îÇ   ‚îú‚îÄ‚îÄ upload-to-ovh.ps1
‚îÇ   ‚îú‚îÄ‚îÄ clean-deploy.bat
‚îÇ   ‚îú‚îÄ‚îÄ push-api-*.bat
‚îÇ   ‚îî‚îÄ‚îÄ deploy-frontend-*.bat
‚îú‚îÄ‚îÄ tests/                   # Scripts de test et debugging
‚îÇ   ‚îú‚îÄ‚îÄ check-vanessa-maladie.js
‚îÇ   ‚îú‚îÄ‚îÄ test-constraints-save.js
‚îÇ   ‚îú‚îÄ‚îÄ test-constraints-final.js
‚îÇ   ‚îî‚îÄ‚îÄ check-new-planning.js
‚îî‚îÄ‚îÄ ARCHITECTURE-PROJET.md
```

---

## üîß **API Endpoints**

### **Employ√©s**
- `GET /api/employees` - Liste des employ√©s
- `POST /api/employees` - Cr√©er un employ√©
- `PUT /api/employees/:id` - Modifier un employ√©
- `DELETE /api/employees/:id` - Supprimer un employ√©
- `PATCH /api/employees/:id/sick-leave` - D√©clarer maladie

### **Contraintes**
- `GET /api/constraints/:weekNumber/:year` - Contraintes d'une semaine
- `POST /api/constraints` - Cr√©er/modifier contraintes
- `PUT /api/constraints/:id` - Modifier contraintes

### **Planning**
- `POST /api/planning/generate` - G√©n√©rer planning
- `GET /api/planning/:weekNumber/:year` - R√©cup√©rer planning
- `PUT /api/planning/:id/validate` - Valider planning
- `PUT /api/planning/:id/realize` - Marquer comme r√©alis√©

### **Absences**
- `POST /api/absences` - D√©clarer absence
- `GET /api/absences/stats` - Statistiques absences
- `GET /api/absences` - Liste des absences
- `DELETE /api/absences/:id` - Supprimer absence

---

## üóÑÔ∏è **Mod√®les de Donn√©es**

### **Employee**
```javascript
{
  name: String (required),
  contractType: ['CDI', 'Apprentissage'],
  age: Number (16-65),
  skills: ['Ouverture', 'Fermeture', 'Management'],
  role: ['vendeuse', 'apprenti', 'responsable', 'manager'],
  weeklyHours: Number (20-39),
  trainingDays: [String],
  contractEndDate: Date,
  sickLeave: {
    isOnSickLeave: Boolean,
    startDate: Date,
    endDate: Date
  },
  isActive: Boolean (default: true)
}
```

### **WeeklyConstraints**
```javascript
{
  weekNumber: Number,
  year: Number,
  employeeId: ObjectId,
  constraints: {
    Lundi: String (enum),
    Mardi: String (enum),
    // ... autres jours
  }
}
```

### **Planning**
```javascript
{
  weekNumber: Number,
  year: Number,
  employeeId: ObjectId,
  employeeName: String,
  schedule: [{
    day: String,
    shifts: [{
      startTime: String,
      endTime: String,
      breakMinutes: Number,
      hoursWorked: Number,
      role: String
    }],
    totalHours: Number,
    constraint: String
  }],
  totalWeeklyHours: Number,
  contractedHours: Number,
  status: ['generated', 'validated', 'realized']
}
```

### **Absence**
```javascript
{
  employeeId: ObjectId,
  employeeName: String,
  type: ['MAL', 'ABS', 'RET'],
  startDate: Date,
  endDate: Date,
  reason: String
}
```

---

## üöÄ **Scripts de D√©ploiement**

### **Backend (Render)**
```bash
# D√©ploiement automatique depuis GitHub
git push origin main
# Render d√©ploie automatiquement
```

### **Frontend (OVH)**
```bash
# Build et upload
npm run build
powershell -File upload-to-ovh.ps1
```

### **‚ö†Ô∏è IMPORTANT - Commandes PowerShell**
- **NE PAS utiliser** `&&` (ne fonctionne pas sur PowerShell)
- **Utiliser** `;` √† la place : `cd frontend; npm run build`
- **Exemple correct** : `cd frontend; npm install; npm run build`
- **Exemple incorrect** : `cd frontend && npm install && npm run build`

---

## ‚ö†Ô∏è **Bonnes Pratiques & Erreurs √âvit√©es**

### **1. Gestion des Erreurs**
- ‚úÖ Timeout Axios : 60s (au lieu de 30s)
- ‚úÖ Gestion des erreurs CORS
- ‚úÖ Validation des donn√©es c√¥t√© serveur
- ‚úÖ Logs d'erreur d√©taill√©s

### **2. D√©ploiement**
- ‚úÖ Scripts de d√©ploiement automatis√©s
- ‚úÖ Versioning automatique (VERSION.md)
- ‚úÖ Force push pour √©viter les conflits Git
- ‚úÖ Nettoyage des fichiers temporaires

### **3. Base de Donn√©es**
- ‚úÖ Indexes optimis√©s
- ‚úÖ Validation des sch√©mas
- ‚úÖ Gestion des contraintes uniques
- ‚úÖ Middleware pour updatedAt
- ‚úÖ **Gestion des arr√™ts maladie** dans le profil employ√©

### **4. Frontend**
- ‚úÖ Routing avec basename `/plan/`
- ‚úÖ Configuration .htaccess pour SPA
- ‚úÖ Gestion des √©tats de chargement
- ‚úÖ Notifications utilisateur
- ‚úÖ **URLs relatives** (sans `/plan/` pr√©fixe) pour √©viter les doublons
- ‚úÖ **Gestion des redirections** : Utiliser des chemins relatifs, pas absolus
- ‚úÖ **Filtrage des contraintes vides** avant envoi √† l'API (√©vite erreur 400)
- ‚úÖ **Affichage intelligent des contraintes** avec prise en compte des arr√™ts maladie
- ‚úÖ **URLs des APIs corrig√©es** (path parameters au lieu de query parameters)
- ‚úÖ **Filtrage des contraintes vides** avant envoi √† l'API (√©vite erreur 400)

### **5. API**
- ‚úÖ Endpoints RESTful
- ‚úÖ Gestion des erreurs HTTP
- ‚úÖ Validation des param√®tres
- ‚úÖ Documentation des endpoints
- ‚úÖ **G√©n√©ration intelligente du planning** avec respect des heures contractuelles
- ‚úÖ **Ajustement automatique** des repos et du travail

---

## üîÑ **Workflow de D√©veloppement**

### **1. Modification Backend**
1. Modifier le code dans `backend/`
2. Tester localement
3. Ex√©cuter script de d√©ploiement : `push-api-*.bat`
4. V√©rifier d√©ploiement Render

### **2. Modification Frontend**
1. Modifier le code dans `frontend/`
2. Tester localement
3. Build et d√©ployer : `deploy-frontend-*.bat`
4. V√©rifier sur OVH

### **3. Debugging**
1. V√©rifier les logs Render
2. Utiliser `test-api-connection.js`
3. V√©rifier la console navigateur
4. Tester les endpoints individuellement
5. **V√©rifier les URLs des APIs** (path parameters vs query parameters)
6. **Contr√¥ler les arr√™ts maladie** dans les profils employ√©s

---

## üìä **Monitoring & Maintenance**

### **Logs**
- **Render** : Logs automatiques
- **MongoDB Atlas** : Monitoring int√©gr√©
- **Frontend** : Console navigateur

### **Backup**
- **MongoDB Atlas** : Backup automatique
- **Code** : GitHub (versioning)
- **Configuration** : Fichiers de config

### **Performance**
- **Frontend** : Build optimis√©
- **Backend** : Compression activ√©e
- **Base de donn√©es** : Indexes optimis√©s

---

## üéØ **Fonctionnalit√©s Principales**

### **‚úÖ Impl√©ment√©es**
- Gestion des employ√©s (CRUD)
- D√©claration de maladie
- Syst√®me d'absences complet
- G√©n√©ration de planning optimis√©e
- Contraintes hebdomadaires
- Tableau de bord avec statistiques
- Interface responsive

### **üîÑ En Cours**
- Optimisation planning (6/7 jours)
- Correction contraintes
- Am√©lioration UX

### **üìã √Ä Impl√©menter**
- Export/Import donn√©es
- Notifications automatiques
- Rapports avanc√©s
- Gestion des cong√©s pay√©s

---

## üîß **Configuration Environnement**

### **Variables d'Environnement**
```bash
# Frontend (.env)
REACT_APP_API_URL=https://boulangerie-planning-api-3.onrender.com/api

# Backend (config-production.js)
MONGODB_URI=mongodb+srv://...
JWT_SECRET=...
CORS_ORIGIN=https://www.filmara.fr
```

## üè• **Gestion des Arr√™ts Maladie et Contraintes**

### **‚úÖ Affichage Intelligent des Contraintes**
**Le syst√®me prend maintenant en compte automatiquement :**
- **Arr√™ts maladie d√©clar√©s** dans le profil employ√©
- **P√©riodes de validit√©** des arr√™ts maladie
- **Affichage coh√©rent** entre contraintes et planning

**Exemple :**
- **Vanessa F** : Arr√™t maladie du 24 ao√ªt au 7 septembre 2025
- **Semaine 36** : Tous les jours affichent "üè• Maladie" (au lieu de "Travail normal")
- **Planning g√©n√©r√©** : Respecte l'arr√™t maladie (MAL partout)

### **üîß Corrections Techniques Impl√©ment√©es**
1. **Filtrage des contraintes vides** avant envoi √† l'API
2. **V√©rification automatique** des arr√™ts maladie par date
3. **Affichage conditionnel** : Select d√©sactiv√© si arr√™t maladie
4. **Style visuel** : Fond rouge pour les jours en arr√™t maladie

### **üìä Structure des Donn√©es**
```javascript
// Mod√®le Employee avec arr√™t maladie
{
  name: "Vanessa F",
  sickLeave: {
    isOnSickLeave: true,
    startDate: "2025-08-24T00:00:00.000Z",
    endDate: "2025-09-07T00:00:00.000Z"
  }
}

// Contraintes avec prise en compte arr√™t maladie
{
  Lundi: "MAL",      // Si en arr√™t maladie
  Mardi: "MAL",      // Si en arr√™t maladie
  // ... autres jours
}
```

---

## üéØ **G√©n√©ration du Planning - Corrections Majeures**

### **‚úÖ Probl√®mes R√©solus**
**Le syst√®me respecte maintenant automatiquement :**
- **Heures contractuelles** de chaque employ√©
- **Contraintes de formation** (compt√©es comme 8h)
- **Cong√©s pay√©s** (compt√©s selon les heures contractuelles)
- **√âquilibre travail/repos** pour atteindre les objectifs

### **üîß Corrections Techniques Impl√©ment√©es**

#### **1. Logique de S√©lection Intelligente**
```javascript
// AVANT : Priorit√© basse si beaucoup d'heures
priority += schedule.totalHours * 10;

// APR√àS : Priorit√© haute si pas assez d'heures
if (schedule.totalHours < employee.weeklyHours) {
  priority -= 100; // Priorit√© tr√®s haute
  if (remainingHours <= 8) {
    priority -= 50; // Priorit√© maximale
  }
}
```

#### **2. Fonction d'Ajustement Automatique**
```javascript
adjustEmployeeSchedule(schedule) {
  // Si trop d'heures ‚Üí ajouter des repos
  // Si pas assez d'heures ‚Üí transformer des repos en travail
  // Logs d√©taill√©s pour debugging
}
```

#### **3. Remplissage Automatique des Jours Vides**
```javascript
fillRemainingDays(schedule) {
  // Trouve les jours vides
  // G√©n√®re des shifts appropri√©s
  // Atteint les heures contractuelles
}
```

### **üìä Exemples de R√©sultats**

#### **Ana√Øs (35h contractuelles) :**
- **Formation** : Mercredi (8h)
- **Travail** : 4 jours pour atteindre 35h
- **Repos** : 2 jours appropri√©s

#### **Camille (35h contractuelles) :**
- **Formation** : Lundi et Mardi (16h)
- **Travail** : 3 jours pour atteindre 35h
- **Repos** : 2 jours appropri√©s

#### **Severine (39h contractuelles) :**
- **Travail** : 6 jours (48h)
- **CP** : Dimanche (6.5h)
- **Total** : 54.5h ‚Üí **Ajust√© automatiquement** √† 39h

### **üöÄ Avantages des Corrections**
1. **Respect automatique** des heures contractuelles
2. **√âquilibre travail/repos** optimal
3. **Gestion intelligente** des contraintes
4. **Logs d√©taill√©s** pour debugging
5. **Planning √©quilibr√©** et respectueux des employ√©s

---

## üåê **Gestion des URLs - R√àGLE IMPORTANTE**
**NE JAMAIS faire :**
```javascript
// ‚ùå INCORRECT - Double pr√©fixe
window.location.href = `/plan/planning`  // Devient /plan/plan/planning
window.location.href = `/plan/constraints`  // Devient /plan/plan/constraints
```

**TOUJOURS faire :**
```javascript
// ‚úÖ CORRECT - URLs relatives
window.location.href = `/planning`  // Devient /plan/planning
window.location.href = `/constraints`  // Devient /plan/constraints
```

### **Pourquoi ?**
- **React Router** : `basename="/plan"` ajoute automatiquement `/plan/`
- **URLs absolues** : `/plan/planning` ‚Üí `/plan/plan/planning` (incorrect)
- **URLs relatives** : `/planning` ‚Üí `/plan/planning` (correct)

### **Exemples de correction :**
```javascript
// ‚ùå Avant (incorrect)
onClick={() => window.location.href = `/plan/planning?week=${weekNumber}&year=${year}`}

// ‚úÖ Apr√®s (correct)
onClick={() => window.location.href = `/planning?week=${weekNumber}&year=${year}`}
```

### **üåê URLs des APIs - R√àGLE IMPORTANTE**
**NE JAMAIS faire :**
```javascript
// ‚ùå INCORRECT - Query parameters
api.get(`/constraints?weekNumber=${week}&year=${year}`)
api.get(`/planning?weekNumber=${week}&year=${year}`)
```

**TOUJOURS faire :**
```javascript
// ‚úÖ CORRECT - Path parameters
api.get(`/constraints/${week}/${year}`)
api.get(`/planning/${week}/${year}`)
```

**Pourquoi ?**
- **Backend** : Routes d√©finies avec `/:weekNumber/:year`
- **Query parameters** : Causent erreur 404 "Route non trouv√©e"
- **Path parameters** : Fonctionnent correctement avec Express.js

---

## üìû **Support & Maintenance**

### **En Cas de Probl√®me**
1. V√©rifier les logs Render
2. Tester l'API avec `test-api-connection.js`
3. V√©rifier la connectivit√© MongoDB
4. Contr√¥ler les variables d'environnement

### **Mise √† Jour**
1. Modifier le code
2. Tester localement
3. D√©ployer avec les scripts appropri√©s
4. V√©rifier le fonctionnement

---

## üî¢ **PROTOCOLE DE VERSIONING**

### **üìã Syst√®me de Versioning**
**√Ä chaque push sur GitHub, nous utilisons un syst√®me de versioning pour identifier facilement les d√©ploiements Render :**

#### **üìÅ Fichier VERSION.md**
```markdown
# üìã VERSION - Boulangerie Planning

## üöÄ Version actuelle : v1.3.1

### üìÖ Derni√®re mise √† jour : 2024-12-19

### üîß Changements dans cette version :
- ‚úÖ Lien avec arr√™ts maladie d√©clar√©s (profil employ√©)
- ‚úÖ R√®gles mineurs strictes (pas de travail dimanche + repos cons√©cutifs)
- ‚úÖ Cadre g√©n√©ral des besoins en personnel appliqu√©
- ‚úÖ Rotation des horaires (ouverture/fermeture)
- ‚úÖ Respect des comp√©tences (ouverture/fermeture)
```

#### **üîÑ Protocole de Push**
1. **Modifier le code** et tester localement
2. **Mettre √† jour VERSION.md** avec :
   - Num√©ro de version incr√©ment√©
   - Date de mise √† jour
   - Liste des changements
3. **Ex√©cuter le script automatis√©** : `push-to-main.bat`
4. **Le script fait automatiquement** :
   - Commit des changements
   - Push sur `master`
   - Switch vers `main`
   - Merge de `master` vers `main`
   - Push sur `main` (d√©clenche Render)

#### **üìÅ Script Automatis√© : push-to-main.bat**
```batch
@echo off
echo ========================================
echo üöÄ PUSH VERS MAIN - Boulangerie Planning
echo ========================================

echo üìã √âtape 1: V√©rification de la branche actuelle...
git branch --show-current

echo üìã √âtape 2: Ajout des fichiers modifi√©s...
git add .

echo üìã √âtape 3: Commit des changements...
git commit -m "üéØ v1.4.0 - INTEGRATION GOOGLE OR-TOOLS + API d√©ploy√©e + Configuration termin√©e"

echo üìã √âtape 4: Push sur master...
git push origin master

echo üìã √âtape 5: Switch vers main...
git checkout main

echo üìã √âtape 6: Merge de master vers main...
git merge master

echo üìã √âtape 7: Push sur main (d√©clenche Render)...
git push origin main

echo üéâ D√âPLOIEMENT TERMIN√â !
echo üìä Version d√©ploy√©e : v1.4.0
echo üåê Render va red√©ployer automatiquement
```

#### **üîç V√©rification sur Render**
**Pour identifier la version d√©ploy√©e :**
1. **Dashboard Render** ‚Üí V√©rifier la date du dernier d√©ploiement
2. **Fichier VERSION.md** ‚Üí Comparer avec la date
3. **Logs Render** ‚Üí V√©rifier les messages de commit

#### **üìä Historique des Versions**
```markdown
#### v1.3.1 (2024-12-19)
- üè• Lien avec arr√™ts maladie d√©clar√©s (profil employ√©)
- üë∂ R√®gles mineurs strictes (pas de travail dimanche + repos cons√©cutifs)
- üìã Cadre g√©n√©ral des besoins en personnel appliqu√©
- üîÑ Rotation des horaires (ouverture/fermeture)
- üéØ Respect des comp√©tences (ouverture/fermeture)

#### v1.3.0 (2024-12-19)
- üöÄ Int√©gration OR-Tools pour optimisation planning
- üîß Rotation automatique des horaires (matin/apr√®s-midi)
- üë∂ R√®gles sp√©ciales pour mineurs (repos cons√©cutifs + dimanche)
- üìä Respect strict des heures contractuelles
- üîÑ √âviter la monotonie des horaires

#### v1.2.3 (2024-12-19)
- üîß Correction comptage formations (8h par jour)
- üîß Am√©lioration ajustement heures contractuelles (tol√©rance 2h/4h)
- üìù Logs d√©taill√©s pour debugging formations
- üîß Correction transformation repos ‚Üî travail

#### v1.2.2 (2024-12-19)
- üîß Syst√®me de versioning automatis√©
- üìù Script `push-to-main.bat` pour d√©ploiement
- üìù Documentation protocole de versioning

#### v1.2.1 (2024-12-19)
- üîß Fix planning - Logique s√©lection + ajustement heures contractuelles
- üìù Mise √† jour documentation architecture

#### v1.2.0 (2024-12-19)
- üîß Fix g√©n√©ration planning - Respect heures contractuelles + gestion contraintes

#### v1.1.0 (2024-12-19)
- Correction des contraintes de planning + am√©lioration frontend
- Correction du respect des contraintes (Formation, CP, MAL)
- Suppression automatique des anciens plannings
- Bouton Maladie/Absence avec menu d√©roulant
- Sauvegarde automatique des contraintes avant g√©n√©ration

#### v1.0.0 (2024-12-19)
- üöÄ Version initiale
- Configuration proxy API et React Router pour d√©ploiement OVH
```

### **üéØ Avantages du Versioning**
1. **Tra√ßabilit√©** : Chaque d√©ploiement est identifi√©
2. **Debugging** : Facilite l'identification des probl√®mes
3. **Rollback** : Possibilit√© de revenir √† une version pr√©c√©dente
4. **Documentation** : Historique complet des changements
5. **Communication** : √âquipe et utilisateurs inform√©s des versions

---

## üìã **R√àGLES DE PLANNING - OBLIGATOIRES**

### **üè• Gestion des Arr√™ts Maladie**
**Le syst√®me v√©rifie automatiquement les arr√™ts maladie d√©clar√©s dans le profil employ√© :**
```javascript
// V√©rification automatique des arr√™ts maladie
if (employee.sickLeave && employee.sickLeave.isOnSickLeave) {
  const startDate = new Date(employee.sickLeave.startDate);
  const endDate = new Date(employee.sickLeave.endDate);
  const dayDate = this.getDateForDay(day, weekNumber, year);
  
  if (dayDate >= startDate && dayDate <= endDate) {
    return { canWork: false, type: 'MAL' };
  }
}
```

**R√®gles appliqu√©es :**
- ‚úÖ **Arr√™t automatique** : L'employ√© est en MAL toute la p√©riode
- ‚úÖ **Pas d'heures compt√©es** : Les jours de maladie ne comptent pas dans le total
- ‚úÖ **Priorit√© absolue** : Les arr√™ts maladie priment sur toutes les autres contraintes

### **üë∂ R√®gles Sp√©ciales pour Mineurs (< 18 ans)**

#### **üö´ Interdictions Absolues**
- **Dimanche** : Aucun travail autoris√©
- **Jours f√©ri√©s** : Aucun travail autoris√©
- **Travail nocturne** : Interdit apr√®s 22h00

#### **üìÖ Repos Cons√©cutifs Obligatoires**
```javascript
// R√®gles pour mineurs
checkMinorRules(employee, day, weekSchedule) {
  if (employee.age >= 18) return { canWork: true };
  
  // Pas de travail le dimanche
  if (day === 'Dimanche') {
    return { canWork: false, reason: 'Dimanche interdit pour mineurs' };
  }
  
  // Repos cons√©cutifs avec dimanche
  const consecutiveRest = this.checkConsecutiveRestForMinor(employee, day, weekSchedule);
  if (!consecutiveRest.valid) {
    return { canWork: false, reason: consecutiveRest.reason };
  }
}
```

**R√®gles appliqu√©es :**
- ‚úÖ **Si travail samedi** ‚Üí Repos dimanche obligatoire
- ‚úÖ **Si travail lundi** ‚Üí Repos dimanche obligatoire
- ‚úÖ **2 jours de repos cons√©cutifs** minimum avec dimanche

### **üìã Cadre G√©n√©ral des Besoins en Personnel**

#### **üè™ Lundi au Vendredi**
```javascript
const requirements = {
  'Lundi': {
    opening: { start: '06:00', end: '13:30', staff: 2, skills: ['Ouverture'] },
    afternoon: { start: '13:30', end: '16:00', staff: 3 },
    evening: { start: '16:00', end: '20:30', staff: 2, skills: ['Fermeture'] }
  }
  // ... autres jours
};
```

**Besoins par p√©riode :**
- **06h00 - 13h30** : 2 vendeuses (dont 1 avec comp√©tence ouverture)
- **13h30 - 16h00** : 3 vendeuses minimum (p√©riode calme)
- **16h00 - 20h30** : 2 vendeuses (dont 1 avec comp√©tence fermeture)

#### **üõí Samedi**
- **06h00 - 16h30** : 3 vendeuses (dont 1 avec comp√©tence ouverture)
- **16h30 - 20h30** : 2 vendeuses (dont 1 avec comp√©tence fermeture)

#### **üåÖ Dimanche**
- **06h00 - 13h00** : 3 vendeuses (dont 1 avec comp√©tence ouverture)
- **13h00 - 20h30** : 2 vendeuses (dont 1 avec comp√©tence fermeture)

### **üîÑ Rotation des Horaires - Anti-Monotonie**

#### **üéØ Objectifs de Rotation**
- ‚úÖ **√âviter la r√©p√©tition** : M√™me employ√© pas au m√™me poste toute la semaine
- ‚úÖ **Alternance matin/apr√®s-midi** : Rotation automatique des horaires
- ‚úÖ **Respect des comp√©tences** : Ouverture/fermeture selon les comp√©tences
- ‚úÖ **√âquit√©** : Distribution √©quitable des t√¢ches

#### **üîß Impl√©mentation Technique**
```javascript
// Rotation des horaires avec OR-Tools
for (let i = 0; i < this.days.length - 1; i++) {
  const day1 = this.days[i];
  const day2 = this.days[i + 1];
  
  // √âviter le m√™me shift deux jours cons√©cutifs
  for (const shiftType of Object.keys(this.shifts)) {
    const consecutive = [
      assignments[employee._id][day1][shiftType],
      assignments[employee._id][day2][shiftType]
    ];
    model.addAtMostOne(consecutive);
  }
}
```

### **‚è∞ Respect des Heures Contractuelles**

#### **üìä Calcul Automatique**
```javascript
// Ajustement automatique des heures
adjustEmployeeSchedule(schedule) {
  const targetHours = employee.weeklyHours;
  const currentHours = schedule.totalHours;
  
  if (currentHours > targetHours + 2) { // Tol√©rance 2h
    // Ajouter des repos pour r√©duire les heures
  } else if (currentHours < targetHours - 4) { // Tol√©rance 4h
    // Transformer des repos en travail
  }
}
```

**R√®gles appliqu√©es :**
- ‚úÖ **Tol√©rance exc√®s** : 2h maximum au-dessus des heures contractuelles
- ‚úÖ **Tol√©rance manque** : 4h maximum en-dessous des heures contractuelles
- ‚úÖ **Ajustement automatique** : Ajout/suppression de repos selon les besoins

### **üéì Gestion des Formations et Cong√©s**

#### **üìö Formations**
- **Comptage** : 8h par jour de formation
- **Priorit√©** : Les formations priment sur le travail
- **Int√©gration** : Compt√©es dans les heures contractuelles

#### **üèñÔ∏è Cong√©s Pay√©s (CP)**
- **Comptage** : 5.5h (35h) ou 6.5h (39h) selon le contrat
- **Priorit√©** : Les CP priment sur le travail
- **Int√©gration** : Compt√©s dans les heures contractuelles

### **üö´ Contraintes Absolues**

#### **üîí Types de Contraintes**
- **Ferm√©** : Boutique ferm√©e (pas de travail)
- **Repos** : Jour de repos (pas d'heures compt√©es)
- **Formation** : Formation obligatoire (8h compt√©es)
- **CP** : Cong√© pay√© (heures selon contrat)
- **MAL** : Arr√™t maladie (pas d'heures compt√©es)
- **ABS** : Absence (pas d'heures compt√©es)
- **RET** : Retard (pas d'heures compt√©es)
- **F√©ri√©** : Jour f√©ri√© (pas d'heures compt√©es)
- **Management** : T√¢ches administratives (heures selon contrat)

### **üéØ Priorit√©s de S√©lection des Employ√©s**

#### **üìä Syst√®me de Priorit√©**
```javascript
calculatePriority(employee, schedule, day, constraintType) {
  let priority = 0;
  
  // Priorit√© HAUTE si pas assez d'heures
  if (schedule.totalHours < employee.weeklyHours) {
    priority -= 100;
    if (remainingHours <= 8) {
      priority -= 50; // Priorit√© maximale
    }
  }
  
  // Priorit√© basse si trop d'heures
  if (schedule.totalHours > employee.weeklyHours) {
    priority += (schedule.totalHours - employee.weeklyHours) * 20;
  }
  
  return priority;
}
```

**Ordre de priorit√© :**
1. **Employ√©s avec moins d'heures** (priorit√© maximale)
2. **Managers/Responsables** (priorit√© haute)
3. **Employ√©s avec comp√©tences sp√©cifiques** (ouverture/fermeture)
4. **√âquilibre travail/repos** (√©viter la surcharge)

---

*Derni√®re mise √† jour : Version 1.4.1 - **CORRECTION CRITIQUE OR-TOOLS** + Suppression m√©thodes dupliqu√©es*
