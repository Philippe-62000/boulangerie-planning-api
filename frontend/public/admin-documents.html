<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Documents - Administration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .upload-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-upload:hover {
            background: #f0f2ff;
            border-color: #5a6fd8;
        }

        .file-upload.dragover {
            background: #e8f0ff;
            border-color: #4c63d2;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 10;
            top: 0;
            left: 0;
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
        }

        .file-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .file-details h4 {
            margin: 0;
            color: #333;
        }

        .file-details p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 0.9rem;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .batch-upload {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .batch-upload h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .batch-upload p {
            color: #856404;
            margin-bottom: 10px;
        }

        .batch-upload ul {
            color: #856404;
            margin-left: 20px;
        }

        .batch-upload li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÅ Gestion des Documents</h1>
            <p>Upload et gestion des documents pour les salari√©s</p>
        </div>

        <div class="content">
            <div id="alertContainer"></div>

            <!-- Upload de documents g√©n√©raux -->
            <div class="upload-section">
                <h2>üìã Documents G√©n√©raux</h2>
                <p>Documents accessibles √† tous les salari√©s (notices, proc√©dures, etc.)</p>
                
                <form id="generalUploadForm">
                    <div class="form-group">
                        <label for="generalTitle">Titre du document :</label>
                        <input type="text" id="generalTitle" name="title" required placeholder="Ex: Notice de s√©curit√©">
                    </div>
                    
                    <div class="form-group">
                        <label for="generalCategory">Cat√©gorie :</label>
                        <select id="generalCategory" name="category" required>
                            <option value="">S√©lectionner une cat√©gorie</option>
                            <option value="notice">Notice</option>
                            <option value="procedure">Proc√©dure</option>
                            <option value="regulation">R√©glementation</option>
                            <option value="training">Formation</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>

                    <div class="file-upload" id="generalFileUpload">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Cliquez pour s√©lectionner un fichier</div>
                        <div class="upload-hint">ou glissez-d√©posez le fichier ici</div>
                        <input type="file" id="generalFile" name="file" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" required>
                    </div>

                    <button type="submit" class="btn">üì§ Uploader le document</button>
                </form>
            </div>

            <!-- Upload de documents personnels -->
            <div class="upload-section">
                <h2>üë§ Documents Personnels</h2>
                <p>Documents sp√©cifiques √† un salari√© (fiches de paie, contrats, etc.)</p>
                
                <form id="personalUploadForm">
                    <div class="form-group">
                        <label for="employeeSelect">Salari√© :</label>
                        <select id="employeeSelect" name="employeeId" required>
                            <option value="">S√©lectionner un salari√©</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="personalTitle">Titre du document :</label>
                        <input type="text" id="personalTitle" name="title" required placeholder="Ex: Fiche de paie - Janvier 2025">
                    </div>
                    
                    <div class="form-group">
                        <label for="personalCategory">Cat√©gorie :</label>
                        <select id="personalCategory" name="category" required>
                            <option value="">S√©lectionner une cat√©gorie</option>
                            <option value="payslip">Fiche de paie</option>
                            <option value="contract">Contrat</option>
                            <option value="certificate">Attestation</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>

                    <div class="file-upload" id="personalFileUpload">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Cliquez pour s√©lectionner un fichier</div>
                        <div class="upload-hint">ou glissez-d√©posez le fichier ici</div>
                        <input type="file" id="personalFile" name="file" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" required>
                    </div>

                    <button type="submit" class="btn">üì§ Uploader le document</button>
                </form>
            </div>

            <!-- Upload par lot -->
            <div class="upload-section">
                <h2>üì¶ Upload par Lot</h2>
                <p>Pour uploader plusieurs documents en une fois (ex: toutes les fiches de paie du mois)</p>
                
                <div class="batch-upload">
                    <h3>üí° Comment utiliser l'upload par lot :</h3>
                    <p><strong>Pour les fiches de paie :</strong></p>
                    <ul>
                        <li>Nommez vos fichiers avec le nom du salari√© : <code>Marie_Dupont_Janvier2025.pdf</code></li>
                        <li>Ou utilisez le format : <code>Nom_Prenom_MoisAnnee.pdf</code></li>
                        <li>Le syst√®me tentera de faire correspondre automatiquement les fichiers aux salari√©s</li>
                    </ul>
                </div>

                <form id="batchUploadForm">
                    <div class="form-group">
                        <label for="batchCategory">Cat√©gorie des documents :</label>
                        <select id="batchCategory" name="category" required>
                            <option value="">S√©lectionner une cat√©gorie</option>
                            <option value="payslip">Fiches de paie</option>
                            <option value="contract">Contrats</option>
                            <option value="certificate">Attestations</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>

                    <div class="file-upload" id="batchFileUpload">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">S√©lectionner plusieurs fichiers</div>
                        <div class="upload-hint">Maintenez Ctrl pour s√©lectionner plusieurs fichiers</div>
                        <input type="file" id="batchFiles" name="files" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" required>
                    </div>

                    <button type="submit" class="btn">üì§ Uploader tous les documents</button>
                </form>

                <div id="batchResults" class="file-list" style="display: none;">
                    <h3>R√©sultats de l'upload par lot :</h3>
                    <div id="batchResultsList"></div>
                </div>
            </div>

            <!-- Liste des documents existants -->
            <div class="upload-section">
                <h2>üìã Documents Existants</h2>
                <button class="btn btn-secondary" onclick="loadDocuments()">üîÑ Actualiser la liste</button>
                
                <div id="documentsList" class="file-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des documents...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://boulangerie-planning-api-4-pbfy.onrender.com/api';

        // Charger les employ√©s au d√©marrage
        document.addEventListener('DOMContentLoaded', async () => {
            await loadEmployees();
            await loadDocuments();
            setupFileUploads();
        });

        // Configuration des zones de drop
        function setupFileUploads() {
            // Zone de drop pour documents g√©n√©raux
            const generalUpload = document.getElementById('generalFileUpload');
            const generalFile = document.getElementById('generalFile');
            
            generalUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                generalUpload.classList.add('dragover');
            });
            
            generalUpload.addEventListener('dragleave', () => {
                generalUpload.classList.remove('dragover');
            });
            
            generalUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                generalUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    generalFile.files = files;
                    updateFileDisplay(generalUpload, files[0].name);
                }
            });
            
            generalFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDisplay(generalUpload, e.target.files[0].name);
                }
            });
            
            // Zone de drop pour documents personnels
            const personalUpload = document.getElementById('personalFileUpload');
            const personalFile = document.getElementById('personalFile');
            
            personalUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                personalUpload.classList.add('dragover');
            });
            
            personalUpload.addEventListener('dragleave', () => {
                personalUpload.classList.remove('dragover');
            });
            
            personalUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                personalUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    personalFile.files = files;
                    updateFileDisplay(personalUpload, files[0].name);
                }
            });
            
            personalFile.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileDisplay(personalUpload, e.target.files[0].name);
                }
            });
            
            // Zone de drop pour upload par lot
            const batchUpload = document.getElementById('batchFileUpload');
            const batchFiles = document.getElementById('batchFiles');
            
            batchUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                batchUpload.classList.add('dragover');
            });
            
            batchUpload.addEventListener('dragleave', () => {
                batchUpload.classList.remove('dragover');
            });
            
            batchUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                batchUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    batchFiles.files = files;
                    updateBatchFileDisplay(batchUpload, files);
                }
            });
            
            batchFiles.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateBatchFileDisplay(batchUpload, Array.from(e.target.files));
                }
            });
        }

        // Mettre √† jour l'affichage du fichier s√©lectionn√©
        function updateFileDisplay(uploadElement, fileName) {
            const textElement = uploadElement.querySelector('.upload-text');
            textElement.textContent = `üìÑ ${fileName}`;
            textElement.style.color = '#27ae60';
            textElement.style.fontWeight = 'bold';
        }

        // Mettre √† jour l'affichage des fichiers par lot
        function updateBatchFileDisplay(uploadElement, files) {
            const textElement = uploadElement.querySelector('.upload-text');
            textElement.textContent = `üìÅ ${files.length} fichier(s) s√©lectionn√©(s)`;
            textElement.style.color = '#27ae60';
            textElement.style.fontWeight = 'bold';
        }

        // Charger la liste des employ√©s
        async function loadEmployees() {
            try {
                const response = await fetch(`${API_URL}/employees`);
                const data = await response.json();
                
                const select = document.getElementById('employeeSelect');
                select.innerHTML = '<option value="">S√©lectionner un salari√©</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee._id;
                        option.textContent = `${employee.name} - ${employee.role}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement employ√©s:', error);
                showAlert('Erreur lors du chargement des employ√©s', 'danger');
            }
        }

        // Charger les documents existants
        async function loadDocuments() {
            const container = document.getElementById('documentsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Chargement des documents...</p></div>';

            try {
                // Charger les documents g√©n√©raux
                const generalResponse = await fetch(`${API_URL}/documents/general`);
                const generalData = await generalResponse.json();

                let html = '<h3>üìã Documents G√©n√©raux</h3>';
                
                if (generalData.success && generalData.data) {
                    generalData.data.forEach(doc => {
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-icon">üìÑ</div>
                                    <div class="file-details">
                                        <h4>${doc.title}</h4>
                                        <p>Cat√©gorie: ${doc.category} | Taille: ${formatFileSize(doc.fileSize)} | Upload: ${formatDate(doc.uploadDate)}</p>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-danger" onclick="deleteDocument('${doc._id}')">üóëÔ∏è Supprimer</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>Aucun document g√©n√©ral trouv√©.</p>';
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur chargement documents:', error);
                container.innerHTML = '<p>Erreur lors du chargement des documents.</p>';
            }
        }

        // Upload document g√©n√©ral
        document.getElementById('generalUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('title', document.getElementById('generalTitle').value);
            formData.append('category', document.getElementById('generalCategory').value);
            formData.append('type', 'general');
            formData.append('file', document.getElementById('generalFile').files[0]);

            await uploadDocument(formData, 'Document g√©n√©ral upload√© avec succ√®s !');
        });

        // Upload document personnel
        document.getElementById('personalUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('employeeId', document.getElementById('employeeSelect').value);
            formData.append('title', document.getElementById('personalTitle').value);
            formData.append('category', document.getElementById('personalCategory').value);
            formData.append('type', 'personal');
            formData.append('file', document.getElementById('personalFile').files[0]);

            await uploadDocument(formData, 'Document personnel upload√© avec succ√®s !');
        });

        // Upload par lot
        document.getElementById('batchUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const files = document.getElementById('batchFiles').files;
            const category = document.getElementById('batchCategory').value;
            
            if (files.length === 0) {
                showAlert('Veuillez s√©lectionner au moins un fichier', 'danger');
                return;
            }

            showAlert('Upload par lot en cours...', 'info');
            
            const results = [];
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                
                // Essayer de deviner l'employ√© √† partir du nom du fichier
                const employeeId = await guessEmployeeFromFilename(file.name);
                
                formData.append('employeeId', employeeId || '');
                formData.append('title', file.name.replace(/\.[^/.]+$/, ""));
                formData.append('category', category);
                formData.append('type', 'personal');
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_URL}/documents/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                        results.push({ file: file.name, status: 'success', message: 'Upload√© avec succ√®s' });
                    } else {
                        errorCount++;
                        results.push({ file: file.name, status: 'error', message: result.error || 'Erreur inconnue' });
                    }
                } catch (error) {
                    errorCount++;
                    results.push({ file: file.name, status: 'error', message: 'Erreur r√©seau' });
                }
            }

            // Afficher les r√©sultats
            displayBatchResults(results, successCount, errorCount);
            showAlert(`Upload termin√© : ${successCount} succ√®s, ${errorCount} erreurs`, successCount > 0 ? 'success' : 'danger');
        });

        // Fonction d'upload g√©n√©rique
        async function uploadDocument(formData, successMessage) {
            try {
                const response = await fetch(`${API_URL}/documents/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(successMessage, 'success');
                    // R√©initialiser les formulaires
                    document.getElementById('generalUploadForm').reset();
                    document.getElementById('personalUploadForm').reset();
                    document.getElementById('batchUploadForm').reset();
                    // Recharger la liste
                    await loadDocuments();
                } else {
                    showAlert(result.error || 'Erreur lors de l\'upload', 'danger');
                }
            } catch (error) {
                console.error('Erreur upload:', error);
                showAlert('Erreur lors de l\'upload du document', 'danger');
            }
        }

        // Deviner l'employ√© √† partir du nom du fichier
        async function guessEmployeeFromFilename(filename) {
            try {
                const response = await fetch(`${API_URL}/employees`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Rechercher par nom dans le fichier
                    for (const employee of data.data) {
                        const nameParts = employee.name.toLowerCase().split(' ');
                        const filenameLower = filename.toLowerCase();
                        
                        // V√©rifier si le nom de l'employ√© est dans le nom du fichier
                        if (nameParts.some(part => part.length > 2 && filenameLower.includes(part))) {
                            return employee._id;
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la recherche d\'employ√©:', error);
            }
            return null;
        }

        // Afficher les r√©sultats de l'upload par lot
        function displayBatchResults(results, successCount, errorCount) {
            const container = document.getElementById('batchResults');
            const list = document.getElementById('batchResultsList');
            
            let html = `<h4>R√©sultats (${successCount} succ√®s, ${errorCount} erreurs) :</h4>`;
            
            results.forEach(result => {
                const icon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                const color = result.status === 'success' ? 'green' : 'red';
                html += `<p style="color: ${color};">${icon} ${result.file}: ${result.message}</p>`;
            });
            
            list.innerHTML = html;
            container.style.display = 'block';
        }

        // Supprimer un document
        async function deleteDocument(documentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce document ?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/documents/${documentId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Document supprim√© avec succ√®s', 'success');
                    await loadDocuments();
                } else {
                    showAlert(result.error || 'Erreur lors de la suppression', 'danger');
                }
            } catch (error) {
                console.error('Erreur suppression:', error);
                showAlert('Erreur lors de la suppression du document', 'danger');
            }
        }

        // Afficher une alerte
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Utilitaires
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR');
        }
    </script>
</body>
</html>
