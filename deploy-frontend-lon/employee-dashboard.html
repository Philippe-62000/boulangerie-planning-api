<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Salarié - Planning Boulangerie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            display: flex;
            align-items: center;
        }

        .logo::before {
            content: "🏢";
            margin-right: 10px;
            font-size: 28px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .employee-name {
            font-weight: 600;
            color: #333;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab:hover:not(.active) {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .tab-panel {
            display: none;
            padding: 40px;
        }

        .tab-panel.active {
            display: block;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .form-subtitle {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .info-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-box h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info-box ul {
            margin: 0;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-control:read-only {
            background: #f8f9fa;
            color: #6c757d;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles pour l'arrêt maladie avec document */
        .sick-leave-document {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .sick-leave-document h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .file-upload {
            border: 2px dashed #2196f3;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .file-upload:hover {
            background: rgba(33, 150, 243, 0.05);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .file-selected {
            color: #28a745;
            font-weight: 600;
        }

        /* Styles pour les documents */
        .document-section {
            display: none;
        }

        .document-section.active {
            display: block;
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .document-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .document-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
        }

        .document-card.general {
            border-left: 4px solid #28a745;
        }

        .document-card.personal {
            border-left: 4px solid #007bff;
        }

        .document-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .document-icon {
            font-size: 2rem;
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .document-title {
            flex: 1;
            min-width: 0;
        }

        .document-title h3 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .document-category {
            display: inline-block;
            background: #e9ecef;
            color: #6c757d;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .expiry-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.25rem 0.75rem;
            border-radius: 0 8px 0 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .expiry-badge.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .expiry-badge.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .expiry-badge.expired {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .document-content {
            margin-bottom: 1.5rem;
        }

        .document-description {
            margin: 0 0 1rem 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
            font-style: italic;
        }

        .document-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.85rem;
        }

        .detail-label {
            color: #6c757d;
            font-weight: 500;
        }

        .detail-value {
            color: #495057;
            font-weight: 600;
        }

        .document-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .download-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        /* Styles pour le modal d'acompte */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
        }

        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .expired-message {
            padding: 0.75rem;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 0.5rem 0;
            color: #6c757d;
            font-size: 1.5rem;
        }

        .empty-state p {
            margin: 0;
            color: #6c757d;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .container {
                margin: 20px auto;
            }
            
            .tab-panel {
                padding: 20px;
            }

            .documents-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .document-header {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .document-icon {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }
            
            .document-title h3 {
                font-size: 1rem;
            }
            
            .detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .download-btn {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">Dashboard Salarié</div>
            <div class="header-subtitle">Planning Boulangerie - Services en ligne</div>
        </div>
    </div>

    <div class="loading" id="initialLoading">
        <div class="spinner"></div>
        <p>Chargement...</p>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <div class="header-content">
                <div class="logo">Dashboard Salarié</div>
                <div class="user-info">
                    <span class="employee-name" id="employeeName">Salarié</span>
                    <a href="#" class="logout-btn" onclick="logout()">
                        🚪 Déconnexion
                    </a>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab" onclick="switchTab('sick-leave')">
                🏥 Arrêt Maladie
            </button>
            <button class="tab active" onclick="switchTab('vacation')">
                🏖️ Demande de Congés
            </button>
            <button class="tab" onclick="switchTab('documents')">
                📁 Mes Documents
            </button>
            <button class="tab" onclick="switchTab('password')">
                🔐 Mot de Passe
            </button>
            <button class="tab" onclick="switchTab('mutuelle')" id="mutuelle-tab" style="display: none;">
                🏥 Mutuelle Personnelle
            </button>
            <button class="tab" onclick="openAdvanceModal()" id="advance-tab" style="display: none;">
                💰 Demande d'Acompte
            </button>
        </div>

        <div class="tab-content">
            <!-- Onglet Demande de Congés (PREMIER) -->
            <div class="tab-panel active" id="vacation-panel">
                <div class="form-container">
                    <h2 class="form-title">🏖️ Demande de Congés</h2>
                    <p class="form-subtitle">Remplissez le formulaire ci-dessous pour faire votre demande</p>

                    <div id="vacationAlert"></div>

                    <div class="info-box">
                        <h4>ℹ️ Informations importantes</h4>
                        <ul>
                            <li>Votre demande sera transmise à votre responsable</li>
                            <li>Vous recevrez une confirmation par email</li>
                            <li>La validation peut prendre quelques jours</li>
                            <li>Vous serez informé de la décision par email</li>
                        </ul>
                    </div>

                    <form id="vacationForm">
                        <div class="form-group">
                            <label class="form-label" for="vacationEmployee">Employé *</label>
                            <input type="text" id="vacationEmployee" class="form-control" readonly>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="vacationStartDate">Date de début *</label>
                                <input type="date" id="vacationStartDate" name="startDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="vacationEndDate">Dernier Jour de Congé *</label>
                                <input type="date" id="vacationEndDate" name="endDate" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="vacationType">Type de congés *</label>
                            <select id="vacationType" name="type" class="form-control" required>
                                <option value="Congés payés">Congés payés</option>
                                <option value="Congés exceptionnels">Congés exceptionnels</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="vacationPrecisions">Précisions (optionnel)</label>
                            <textarea id="vacationPrecisions" name="precisions" class="form-control" rows="3" placeholder="Précisions sur votre demande de congés..."></textarea>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="vacationBtn">
                                🏖️ Demander les congés
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetVacationForm()" style="margin-left: 10px;">
                                🔄 Réinitialiser
                            </button>
                        </div>
                    </form>

                    <div class="loading" id="vacationLoading">
                        <div class="spinner"></div>
                        <p>Traitement en cours...</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Arrêt Maladie (AVEC DOCUMENT) -->
            <div class="tab-panel" id="sick-leave-panel">
                <div class="form-container">
                    <h2 class="form-title">🏥 Déclarer un Arrêt Maladie</h2>
                    <p class="form-subtitle">Déclarez votre arrêt maladie avec document</p>

                    <div id="sickLeaveAlert"></div>

                    <div class="info-box">
                        <h4>ℹ️ Informations importantes</h4>
                        <ul>
                            <li>Les dates sont inclusives (début et fin comprises)</li>
                            <li>Un email de confirmation vous sera envoyé</li>
                        </ul>
                    </div>

                    <div class="sick-leave-document">
                        <h4>📄 Exigences pour le document</h4>
                        <ul>
                            <li>Fichier JPG ou PDF uniquement</li>
                            <li>Taille maximum : 10MB</li>
                            <li>Document lisible et de bonne qualité</li>
                            <li>Doit contenir les dates de début et fin d'arrêt</li>
                        </ul>
                    </div>

                    <form id="sickLeaveForm" enctype="multipart/form-data">
                        <input type="hidden" name="type" value="Arrêt maladie">

                        <div class="form-group">
                            <label class="form-label" for="sickLeaveEmployee">Employé *</label>
                            <input type="text" id="sickLeaveEmployee" name="employeeName" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="sickLeaveEmployeeEmail">Email *</label>
                            <input type="email" id="sickLeaveEmployeeEmail" name="employeeEmail" class="form-control" readonly>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="sickLeaveStartDate">Date de début *</label>
                                <input type="date" id="sickLeaveStartDate" name="startDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="sickLeaveEndDate">Date de fin *</label>
                                <input type="date" id="sickLeaveEndDate" name="endDate" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="sickLeaveDocument">Document d'arrêt maladie *</label>
                            <div class="file-upload" onclick="document.getElementById('sickLeaveDocument').click()">
                                <input type="file" id="sickLeaveDocument" name="document" accept=".jpg,.jpeg,.pdf" required>
                                <div class="file-upload-label">
                                    <div style="font-size: 24px;">📤</div>
                                    <div>Cliquez pour sélectionner un fichier</div>
                                    <div class="file-info">JPG, PDF (max 10MB)</div>
                                    <div class="file-info" id="fileName" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="sickLeaveBtn">
                                📤 Envoyer l'arrêt maladie
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetSickLeaveForm()" style="margin-left: 10px;">
                                🔄 Réinitialiser
                            </button>
                        </div>
                    </form>

                    <div class="loading" id="sickLeaveLoading">
                        <div class="spinner"></div>
                        <p>Traitement en cours...</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Mutuelle Personnelle -->
            <div class="tab-panel" id="mutuelle-panel">
                <div class="form-container">
                    <h2 class="form-title">🏥 Justificatif de Mutuelle Personnelle</h2>
                    <p class="form-subtitle">Déposez votre justificatif de mutuelle personnelle</p>

                    <div id="mutuelleAlert"></div>

                    <div class="info-box">
                        <h4>ℹ️ Informations importantes</h4>
                        <p><strong>J'ai renoncé au bénéfice des garanties de frais de santé prévues par le contrat collectif et obligatoire de l'entreprise.</strong></p>
                        <p>En effet, étant donné que j'ai un motif qui me permet de refuser la couverture complémentaire obligatoire, la réglementation m'autorise à refuser d'adhérer à cette mutuelle santé.</p>
                        <p>Je joins les pièces justificatives.</p>
                        <h5>Cas de dispense :</h5>
                        <ul>
                            <li>Vous avez déjà une mutuelle santé souscrite à titre individuel (la dispense d'adhésion joue alors jusqu'à la date d'échéance de votre contrat existant)</li>
                            <li>Vous faites partie des ayants droit de la mutuelle santé collective de votre époux ou partenaire de PACS (dans le cas d'une mutuelle santé familiale ou encore d'un contrat de groupe dit Madelin)</li>
                            <li>Vous êtes bénéficiaire de la complémentaire santé solidaire (CSS, ex-CMU-C)</li>
                        </ul>
                    </div>

                    <div class="sick-leave-document">
                        <h4>📄 Exigences pour le document</h4>
                        <ul>
                            <li>Fichier JPG ou PDF uniquement</li>
                            <li>Taille maximum : 10MB</li>
                            <li>Document lisible et de bonne qualité</li>
                            <li>Doit être un justificatif valide (attestation de mutuelle, contrat, etc.)</li>
                        </ul>
                    </div>

                    <form id="mutuelleForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label class="form-label" for="mutuelleEmployee">Employé *</label>
                            <input type="text" id="mutuelleEmployee" name="employeeName" class="form-control" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="mutuelleEmployeeEmail">Email *</label>
                            <input type="email" id="mutuelleEmployeeEmail" name="employeeEmail" class="form-control" readonly>
                        </div>

                        <input type="hidden" id="mutuelleEmployeeId" name="employeeId">

                        <div class="form-group">
                            <label class="form-label" for="mutuelleDocument">Justificatif de mutuelle personnelle *</label>
                            <div class="file-upload" onclick="document.getElementById('mutuelleDocument').click()">
                                <input type="file" id="mutuelleDocument" name="document" accept=".jpg,.jpeg,.pdf" required>
                                <div class="file-upload-label">
                                    <div style="font-size: 24px;">📤</div>
                                    <div>Cliquez pour sélectionner un fichier</div>
                                    <div class="file-info">JPG, PDF (max 10MB)</div>
                                    <div class="file-info" id="mutuelleFileName" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="mutuelleBtn">
                                📤 Envoyer le justificatif
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetMutuelleForm()" style="margin-left: 10px;">
                                🔄 Réinitialiser
                            </button>
                        </div>
                    </form>

                    <div class="loading" id="mutuelleLoading">
                        <div class="spinner"></div>
                        <p>Traitement en cours...</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Mes Documents -->
            <div class="tab-panel" id="documents-panel">
                <div class="form-container">
                    <h2 class="form-title">📁 Mes Documents</h2>
                    <p class="form-subtitle">Consultez et téléchargez vos documents personnels et généraux</p>

                    <div id="documentsAlert"></div>

                    <div class="info-box">
                        <h4>ℹ️ Informations importantes</h4>
                        <ul>
                            <li>📋 Les <strong>documents généraux</strong> sont accessibles à tous les employés</li>
                            <li>👤 Les <strong>documents personnels</strong> sont spécifiques à votre compte</li>
                            <li>⏰ Les documents personnels sont automatiquement supprimés après 1 mois</li>
                            <li>📥 Cliquez sur "Télécharger" pour sauvegarder un document sur votre appareil</li>
                        </ul>
                    </div>

                    <!-- Onglets pour les types de documents -->
                    <div class="tabs" style="margin-bottom: 30px;">
                        <button class="tab" onclick="switchDocumentTab('general')" id="general-tab">
                            📋 Documents Généraux
                        </button>
                        <button class="tab active" onclick="switchDocumentTab('personal')" id="personal-tab">
                            👤 Mes Documents Personnels
                        </button>
                    </div>

                    <!-- Section Documents Généraux -->
                    <div class="document-section" id="general-documents">
                        <div class="loading" id="generalLoading">
                            <div class="spinner"></div>
                            <p>Chargement des documents généraux...</p>
                        </div>
                        <div id="generalDocumentsList" style="display: none;">
                            <!-- Les documents généraux seront chargés ici -->
                        </div>
                    </div>

                    <!-- Section Documents Personnels -->
                    <div class="document-section" id="personal-documents">
                        <div class="loading" id="personalLoading">
                            <div class="spinner"></div>
                            <p>Chargement de vos documents personnels...</p>
                        </div>
                        <div id="personalDocumentsList" style="display: none;">
                            <!-- Les documents personnels seront chargés ici -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Mot de Passe -->
            <div class="tab-panel" id="password-panel">
                <div class="form-container">
                    <h2 class="form-title">🔐 Changer mon mot de passe</h2>
                    <p class="form-subtitle">Modifiez votre mot de passe pour sécuriser votre compte</p>

                    <div id="passwordAlert"></div>

                    <form id="passwordForm" class="form">
                        <div class="form-group">
                            <label for="currentPassword">Mot de passe actuel *</label>
                            <input type="password" id="currentPassword" name="currentPassword" required>
                        </div>

                        <div class="form-group">
                            <label for="newPassword">Nouveau mot de passe *</label>
                            <input type="password" id="newPassword" name="newPassword" required minlength="6">
                            <small class="form-text">Le mot de passe doit contenir au moins 6 caractères</small>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Confirmer le nouveau mot de passe *</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-text">Changer le mot de passe</span>
                                <div class="btn-loading" style="display: none;">
                                    <div class="spinner"></div>
                                </div>
                            </button>
                        </div>
                    </form>

                    <div class="info-box">
                        <h4>ℹ️ Informations importantes</h4>
                        <ul>
                            <li>🔒 Votre mot de passe actuel est requis pour confirmer votre identité</li>
                            <li>🛡️ Le nouveau mot de passe doit contenir au moins 6 caractères</li>
                            <li>✅ Après le changement, vous devrez vous reconnecter avec votre nouveau mot de passe</li>
                            <li>⚠️ Si vous oubliez votre mot de passe, contactez votre manager</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Demande d'Acompte -->
    <div id="advanceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAdvanceModal()">&times;</span>
            <h2>💰 Demande d'Acompte sur Salaire</h2>
            <p class="form-subtitle">Demandez une avance sur votre salaire</p>

            <div id="advanceAlert"></div>

            <form id="advanceForm" class="form">
                <div class="form-group">
                    <label for="advanceAmount">Montant demandé (€) *</label>
                    <input type="number" id="advanceAmount" name="advanceAmount" min="1" max="5000" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="deductionMonth">Déduction sur la paye de : *</label>
                    <input type="text" id="deductionMonth" name="deductionMonth" readonly class="form-control" style="background-color: #f5f5f5; cursor: not-allowed;">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">💰 Demander l'acompte</span>
                        <div class="btn-loading" style="display: none;">
                            <div class="spinner"></div>
                        </div>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAdvanceModal()">
                        Annuler
                    </button>
                </div>
            </form>

            <div class="info-box">
                <h4>ℹ️ Informations importantes</h4>
                <ul>
                    <li>💰 Le montant sera déduit de votre prochaine paye</li>
                    <li>📧 Vous recevrez une confirmation par email</li>
                    <li>⏰ La validation peut prendre quelques jours</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://boulangerie-planning-api-3.onrender.com/api';
        let currentEmployee = null;

        // Vérifier l'authentification au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await checkAuthentication();
            } catch (error) {
                console.error('Erreur vérification auth:', error);
                redirectToLogin();
            }
        });

        async function checkAuthentication() {
            const token = localStorage.getItem('employeeToken');
            if (!token) {
                redirectToLogin();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/employee-profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token invalide');
                }

                const data = await response.json();
                console.log('🔍 Données reçues de l\'API employee-profile:', data);
                currentEmployee = data.employee;
                console.log('🔍 currentEmployee défini:', currentEmployee);
                console.log('🔍 currentEmployee.id:', currentEmployee ? currentEmployee.id : 'undefined');
                
                // Afficher les informations de l'employé
                document.getElementById('employeeName').textContent = currentEmployee.name;
                document.getElementById('vacationEmployee').value = currentEmployee.name;
                document.getElementById('sickLeaveEmployee').value = currentEmployee.name;
                document.getElementById('sickLeaveEmployeeEmail').value = currentEmployee.email;
                document.getElementById('mutuelleEmployee').value = currentEmployee.name;
                document.getElementById('mutuelleEmployeeEmail').value = currentEmployee.email;
                document.getElementById('mutuelleEmployeeId').value = currentEmployee.id || currentEmployee._id;

                // Afficher l'onglet Mutuelle si l'employé a choisi "Non Perso"
                if (currentEmployee.mutuelle === 'Non Perso') {
                    document.getElementById('mutuelle-tab').style.display = 'block';
                }

                // Masquer le loading et afficher le contenu
                document.getElementById('initialLoading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                // Vérifier si la demande d'acompte est activée
                await checkAdvanceRequestAvailability();

            } catch (error) {
                console.error('Erreur authentification:', error);
                redirectToLogin();
            }
        }

        async function checkAdvanceRequestAvailability() {
            try {
                // Vérifier que currentEmployee est chargé
                if (!currentEmployee || !currentEmployee.id) {
                    console.log('⏳ Attente du chargement de currentEmployee pour vérifier l\'accès à l\'acompte...');
                    setTimeout(checkAdvanceRequestAvailability, 500);
                    return;
                }

                const response = await fetch(`${API_URL}/parameters`);
                const parameters = await response.json();
                
                const advanceParam = parameters.find(p => p.name === 'enableEmployeeAdvanceRequest');
                let isAllowed = false;
                
                if (advanceParam) {
                    // Le paramètre contient maintenant une liste JSON d'IDs d'employés
                    if (advanceParam.stringValue) {
                        try {
                            const allowedEmployees = JSON.parse(advanceParam.stringValue || '[]');
                            isAllowed = Array.isArray(allowedEmployees) && allowedEmployees.includes(currentEmployee.id);
                        } catch (e) {
                            console.error('Erreur parsing liste employés autorisés:', e);
                            // Fallback pour compatibilité avec l'ancien système (booleanValue)
                            isAllowed = advanceParam.booleanValue === true;
                        }
                    } else if (advanceParam.booleanValue) {
                        // Fallback pour compatibilité avec l'ancien système
                        isAllowed = advanceParam.booleanValue === true;
                    }
                }
                
                const advanceTab = document.getElementById('advance-tab');
                if (advanceTab) {
                    if (isAllowed) {
                        advanceTab.style.display = 'block';
                        console.log('✅ Demande d\'acompte activée pour:', currentEmployee.name);
                    } else {
                        advanceTab.style.display = 'none';
                        console.log('ℹ️ Demande d\'acompte non autorisée pour:', currentEmployee.name);
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la vérification du paramètre d\'acompte:', error);
                // En cas d'erreur, masquer le bouton par défaut
                const advanceTab = document.getElementById('advance-tab');
                if (advanceTab) {
                    advanceTab.style.display = 'none';
                }
            }
        }

        function redirectToLogin() {
            window.location.href = '/lon/salarie-connexion.html';
        }

        function logout() {
            localStorage.removeItem('employeeToken');
            redirectToLogin();
        }

        function getRoleLabel(role) {
            const roleLabels = {
                'vendeuse': 'Vendeuse',
                'boulanger': 'Boulanger',
                'preparateur': 'Préparateur',
                'manager': 'Manager'
            };
            return roleLabels[role] || role;
        }

        function switchTab(tabName) {
            // Masquer tous les panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activer l'onglet et le panel sélectionnés
            const tabButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            const panel = document.getElementById(`${tabName}-panel`);
            if (panel) {
                panel.classList.add('active');
            }

            // Si c'est l'onglet documents, charger les documents personnels par défaut
            if (tabName === 'documents') {
                // Attendre que currentEmployee soit chargé avant d'activer l'onglet documents
                if (currentEmployee && currentEmployee.id) {
                    switchDocumentTab('personal');
                } else {
                    console.log('⏳ Attente du chargement de currentEmployee pour l\'onglet documents...');
                    // Réessayer après un court délai
                    setTimeout(() => {
                        if (currentEmployee && currentEmployee.id) {
                            switchDocumentTab('personal');
                        } else {
                            console.error('❌ currentEmployee toujours non disponible pour l\'onglet documents');
                            showAlert('documentsAlert', '⚠️ Erreur: Impossible de charger les informations employé', 'danger');
                        }
                    }, 500);
                }
            }
        }

        // Gestion du fichier upload
        document.getElementById('sickLeaveDocument').addEventListener('change', function(e) {
            const fileName = document.getElementById('fileName');
            if (e.target.files.length > 0) {
                fileName.textContent = `Fichier sélectionné: ${e.target.files[0].name}`;
                fileName.style.display = 'block';
                fileName.classList.add('file-selected');
            } else {
                fileName.style.display = 'none';
                fileName.classList.remove('file-selected');
            }
        });

        // Gestion du formulaire de demande de congés
        document.getElementById('vacationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                employeeName: currentEmployee.name,
                employeeEmail: currentEmployee.email,
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate'),
                reason: formData.get('type'),
                precisions: formData.get('precisions') || ''
            };

            // Validation des dates
            if (new Date(data.startDate) > new Date(data.endDate)) {
                showAlert('vacationAlert', 'La date de début doit être antérieure à la date de fin');
                return;
            }

            hideAlert('vacationAlert');
            setFormEnabled('vacationForm', false);

            try {
                const response = await fetch(`${API_URL}/vacation-requests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('vacationAlert', 'Demande de congés envoyée avec succès ! Vous recevrez une confirmation par email.', 'success');
                    resetVacationForm();
                } else {
                    showAlert('vacationAlert', result.error || 'Erreur lors de la demande');
                }
            } catch (error) {
                console.error('Erreur demande congés:', error);
                showAlert('vacationAlert', 'Erreur de connexion. Vérifiez votre connexion internet.');
            } finally {
                setFormEnabled('vacationForm', true);
            }
        });

        // Gestion du formulaire de mutuelle
        document.getElementById('mutuelleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);

            hideAlert('mutuelleAlert');
            setFormEnabled('mutuelleForm', false);

            try {
                const response = await fetch(`${API_URL}/mutuelle/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('mutuelleAlert', 'Justificatif mutuelle envoyé avec succès ! Vous recevrez une confirmation par email.', 'success');
                    resetMutuelleForm();
                } else {
                    showAlert('mutuelleAlert', result.error || 'Erreur lors de l\'envoi');
                }
            } catch (error) {
                console.error('Erreur envoi justificatif mutuelle:', error);
                showAlert('mutuelleAlert', 'Erreur de connexion. Vérifiez votre connexion internet.');
            } finally {
                setFormEnabled('mutuelleForm', true);
            }
        });

        // Gestion du formulaire d'arrêt maladie avec document
        document.getElementById('sickLeaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Validation des dates
            const startDate = new Date(formData.get('startDate'));
            const endDate = new Date(formData.get('endDate'));
            
            if (startDate > endDate) {
                showAlert('sickLeaveAlert', 'La date de début doit être antérieure à la date de fin');
                return;
            }

            hideAlert('sickLeaveAlert');
            setFormEnabled('sickLeaveForm', false);

            try {
                const response = await fetch(`${API_URL}/sick-leaves/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('sickLeaveAlert', 'Arrêt maladie déclaré avec succès ! Vous recevrez une confirmation par email.', 'success');
                    resetSickLeaveForm();
                } else {
                    showAlert('sickLeaveAlert', result.error || 'Erreur lors de la déclaration');
                }
            } catch (error) {
                console.error('Erreur déclaration arrêt maladie:', error);
                showAlert('sickLeaveAlert', 'Erreur de connexion. Vérifiez votre connexion internet.');
            } finally {
                setFormEnabled('sickLeaveForm', true);
            }
        });

        function showAlert(alertId, message, type = 'danger') {
            const alert = document.getElementById(alertId);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
        }

        function hideAlert(alertId) {
            const alert = document.getElementById(alertId);
            alert.style.display = 'none';
        }

        function setFormEnabled(formId, enabled) {
            const form = document.getElementById(formId);
            const loading = document.getElementById(formId.replace('Form', 'Loading'));
            
            if (enabled) {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';
                loading.classList.remove('show');
            } else {
                form.style.opacity = '0.6';
                form.style.pointerEvents = 'none';
                loading.classList.add('show');
            }
        }

        function resetVacationForm() {
            document.getElementById('vacationForm').reset();
            document.getElementById('vacationEmployee').value = currentEmployee.name;
            hideAlert('vacationAlert');
        }

        function resetSickLeaveForm() {
            document.getElementById('sickLeaveForm').reset();
            document.getElementById('sickLeaveEmployee').value = currentEmployee.name;
            document.getElementById('sickLeaveEmployeeEmail').value = currentEmployee.email;
            document.getElementById('fileName').style.display = 'none';
            document.getElementById('fileName').classList.remove('file-selected');
            hideAlert('sickLeaveAlert');
        }

        function resetMutuelleForm() {
            document.getElementById('mutuelleForm').reset();
            document.getElementById('mutuelleEmployee').value = currentEmployee.name;
            document.getElementById('mutuelleEmployeeEmail').value = currentEmployee.email;
            document.getElementById('mutuelleEmployeeId').value = currentEmployee.id || currentEmployee._id;
            document.getElementById('mutuelleFileName').style.display = 'none';
            document.getElementById('mutuelleFileName').classList.remove('file-selected');
            hideAlert('mutuelleAlert');
        }

        // Gestion de l'affichage du nom de fichier pour mutuelle
        document.getElementById('mutuelleDocument').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileNameDiv = document.getElementById('mutuelleFileName');
            if (file) {
                fileNameDiv.textContent = `📄 ${file.name}`;
                fileNameDiv.style.display = 'block';
                fileNameDiv.classList.add('file-selected');
            } else {
                fileNameDiv.style.display = 'none';
                fileNameDiv.classList.remove('file-selected');
            }
        });

        // Fonctions pour la gestion des documents
        function switchDocumentTab(tabType) {
            // Masquer toutes les sections
            document.querySelectorAll('.document-section').forEach(section => {
                section.classList.remove('active');
            });

            // Désactiver tous les onglets de documents
            document.querySelectorAll('#general-tab, #personal-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Activer la section et l'onglet sélectionnés
            document.getElementById(`${tabType}-documents`).classList.add('active');
            document.getElementById(`${tabType}-tab`).classList.add('active');

            // Charger les documents si nécessaire
            if (tabType === 'general') {
                loadGeneralDocuments();
            } else if (tabType === 'personal') {
                // Vérifier que currentEmployee est chargé avant de charger les documents personnels
                if (currentEmployee && currentEmployee.id) {
                    loadPersonalDocuments();
                } else {
                    console.log('⏳ Attente du chargement des informations employé...');
                    showAlert('documentsAlert', '⏳ Chargement des informations employé en cours...', 'info');
                    // Réessayer après un court délai
                    setTimeout(() => {
                        if (currentEmployee && currentEmployee.id) {
                            loadPersonalDocuments();
                        } else {
                            showAlert('documentsAlert', '⚠️ Erreur: Impossible de charger les informations employé', 'danger');
                        }
                    }, 1000);
                }
            }
        }

        async function loadGeneralDocuments() {
            const loading = document.getElementById('generalLoading');
            const list = document.getElementById('generalDocumentsList');
            
            loading.style.display = 'block';
            list.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/documents/general`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('employeeToken')}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // Route pas encore déployée - afficher message informatif
                        displayDocuments('generalDocumentsList', [], 'general');
                        showAlert('documentsAlert', '⚠️ Service de documents en cours de déploiement. Réessayez dans quelques minutes.', 'info');
                        return;
                    }
                    throw new Error('Erreur lors du chargement des documents généraux');
                }

                const data = await response.json();
                console.log('📄 Documents généraux reçus:', data);
                displayDocuments('generalDocumentsList', data.data || data.documents || [], 'general');
                
            } catch (error) {
                console.error('Erreur chargement documents généraux:', error);
                // Afficher un message plus informatif
                displayDocuments('generalDocumentsList', [], 'general');
                showAlert('documentsAlert', '⚠️ Service de documents temporairement indisponible. Réessayez dans quelques minutes.', 'info');
            } finally {
                loading.style.display = 'none';
                list.style.display = 'block';
            }
        }

        async function loadPersonalDocuments() {
            const loading = document.getElementById('personalLoading');
            const list = document.getElementById('personalDocumentsList');
            
            loading.style.display = 'block';
            list.style.display = 'none';

            // Vérifier que currentEmployee est défini
            if (!currentEmployee || !currentEmployee.id) {
                console.error('❌ currentEmployee non défini:', currentEmployee);
                console.log('🔍 État de currentEmployee:', {
                    currentEmployee: currentEmployee,
                    hasId: currentEmployee ? !!currentEmployee.id : false,
                    id: currentEmployee ? currentEmployee.id : 'undefined'
                });
                displayDocuments('personalDocumentsList', [], 'personal');
                showAlert('documentsAlert', '⚠️ Erreur: Informations employé non disponibles. Veuillez vous reconnecter.', 'danger');
                loading.style.display = 'none';
                list.style.display = 'block';
                return;
            }

            console.log('✅ Chargement documents personnels pour:', currentEmployee.name, 'ID:', currentEmployee.id);

            try {
                const response = await fetch(`${API_URL}/documents/personal/${currentEmployee.id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('employeeToken')}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // Route pas encore déployée - afficher message informatif
                        displayDocuments('personalDocumentsList', [], 'personal');
                        showAlert('documentsAlert', '⚠️ Service de documents en cours de déploiement. Réessayez dans quelques minutes.', 'info');
                        return;
                    }
                    throw new Error('Erreur lors du chargement de vos documents personnels');
                }

                const data = await response.json();
                console.log('📄 Documents personnels reçus:', data);
                displayDocuments('personalDocumentsList', data.data || data.documents || [], 'personal');
                
            } catch (error) {
                console.error('Erreur chargement documents personnels:', error);
                // Afficher un message plus informatif
                displayDocuments('personalDocumentsList', [], 'personal');
                showAlert('documentsAlert', '⚠️ Service de documents temporairement indisponible. Réessayez dans quelques minutes.', 'info');
            } finally {
                loading.style.display = 'none';
                list.style.display = 'block';
            }
        }

        function displayDocuments(containerId, documents, type) {
            console.log(`🔍 displayDocuments appelé:`, { containerId, documents, type });
            const container = document.getElementById(containerId);
            
            if (!documents || documents.length === 0) {
                console.log(`📁 Aucun document trouvé pour ${type}`);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <h3>Aucun document disponible</h3>
                        <p>${type === 'general' ? 'Aucun document général n\'est disponible pour le moment.' : 'Vous n\'avez aucun document personnel.'}</p>
                    </div>
                `;
                return;
            }
            
            console.log(`📄 Affichage de ${documents.length} documents ${type}`);

            const documentsHtml = documents.map(doc => {
                const icon = getDocumentIcon(doc.category);
                const expiryInfo = getExpiryInfo(doc);
                const isExpired = doc.expiryDate && new Date(doc.expiryDate) < new Date();
                
                return `
                    <div class="document-card ${type}">
                        <div class="document-header">
                            <div class="document-icon">${icon}</div>
                            <div class="document-title">
                                <h3>${doc.title}</h3>
                                <span class="document-category">${getCategoryLabel(doc.category)}</span>
                            </div>
                            ${expiryInfo ? `<div class="expiry-badge ${expiryInfo.class}">${expiryInfo.text}</div>` : ''}
                        </div>
                        
                        <div class="document-content">
                            <div class="document-details">
                                <div class="detail-item">
                                    <span class="detail-label">Taille</span>
                                    <span class="detail-value">${formatFileSize(doc.fileSize)}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Ajouté le</span>
                                    <span class="detail-value">${formatDate(doc.uploadDate)}</span>
                                </div>
                                ${doc.downloadCount > 0 ? `
                                    <div class="detail-item">
                                        <span class="detail-label">Téléchargements</span>
                                        <span class="detail-value">${doc.downloadCount}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="document-actions">
                            ${isExpired ? `
                                <div class="expired-message">
                                    ⚠️ Ce document a expiré et ne peut plus être téléchargé
                                </div>
                            ` : `
                                <button class="download-btn" onclick="downloadDocument('${doc._id}', '${type}')">
                                    📥 Télécharger
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="documents-grid">${documentsHtml}</div>`;
        }

        function getDocumentIcon(category) {
            const icons = {
                'notice': '📋',
                'procedure': '📄',
                'formation': '🎓',
                'payslip': '💰',
                'contract': '📝',
                'rh': '👤',
                'other': '📄'
            };
            return icons[category] || icons['other'];
        }

        function getCategoryLabel(category) {
            const labels = {
                'notice': 'Notice',
                'procedure': 'Procédure',
                'formation': 'Formation',
                'payslip': 'Fiche de paie',
                'contract': 'Contrat',
                'rh': 'RH',
                'other': 'Autre'
            };
            return labels[category] || category;
        }

        function getExpiryInfo(doc) {
            if (!doc.expiryDate) return null;
            
            const now = new Date();
            const expiry = new Date(doc.expiryDate);
            const daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
            
            if (daysLeft < 0) {
                return { class: 'expired', text: 'Expiré' };
            } else if (daysLeft <= 3) {
                return { class: 'warning', text: `${daysLeft}j restant` };
            } else if (daysLeft <= 7) {
                return { class: 'info', text: `${daysLeft}j restant` };
            }
            return null;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        async function downloadDocument(documentId, documentType = 'general') {
            try {
                let apiUrl = `${API_URL}/documents/${documentId}/download`;
                
                // Pour les documents personnels, ajouter l'employeeId en paramètre
                if (documentType === 'personal' && currentEmployee && currentEmployee.id) {
                    apiUrl += `?employeeId=${currentEmployee.id}`;
                }
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('employeeToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors du téléchargement');
                }

                // Créer un lien de téléchargement
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = ''; // Le nom sera déterminé par le serveur
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);

                showAlert('documentsAlert', 'Document téléchargé avec succès !', 'success');
                
            } catch (error) {
                console.error('Erreur téléchargement:', error);
                showAlert('documentsAlert', 'Erreur lors du téléchargement du document', 'danger');
            }
        }

        // Gestion du formulaire de changement de mot de passe
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            // Validation côté client
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('passwordAlert', 'Tous les champs sont requis', 'danger');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('passwordAlert', 'Le nouveau mot de passe doit contenir au moins 6 caractères', 'danger');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('passwordAlert', 'Les mots de passe ne correspondent pas', 'danger');
                return;
            }
            
            // Afficher le loading
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('employeeToken')}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('passwordAlert', '✅ Mot de passe changé avec succès ! Vous allez être déconnecté.', 'success');
                    
                    // Vider le formulaire
                    e.target.reset();
                    
                    // Déconnexion automatique après 2 secondes
                    setTimeout(() => {
                        localStorage.removeItem('employeeToken');
                        window.location.href = '/lon/salarie-connexion.html';
                    }, 2000);
                    
                } else {
                    showAlert('passwordAlert', `❌ ${data.message || 'Erreur lors du changement de mot de passe'}`, 'danger');
                }
                
            } catch (error) {
                console.error('Erreur changement mot de passe:', error);
                showAlert('passwordAlert', '❌ Erreur de connexion. Veuillez réessayer.', 'danger');
            } finally {
                // Restaurer le bouton
                btnText.style.display = 'block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Fonctions pour le modal d'acompte
        function openAdvanceModal() {
            document.getElementById('advanceModal').style.display = 'block';
            // Définir automatiquement le mois courant (lecture seule)
            const currentDate = new Date();
            const currentMonth = currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            document.getElementById('deductionMonth').value = currentMonth;
            // Réinitialiser le montant
            document.getElementById('advanceAmount').value = '';
        }

        function closeAdvanceModal() {
            document.getElementById('advanceModal').style.display = 'none';
            document.getElementById('advanceForm').reset();
            document.getElementById('advanceAlert').innerHTML = '';
        }

        // Fermer le modal en cliquant à l'extérieur
        window.onclick = function(event) {
            const modal = document.getElementById('advanceModal');
            if (event.target === modal) {
                closeAdvanceModal();
            }
        }

        // Gestion du formulaire de demande d'acompte
        document.getElementById('advanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const amount = parseFloat(formData.get('advanceAmount'));
            const deductionMonth = formData.get('deductionMonth');
            
            // Validation côté client
            if (!amount || amount < 1 || amount > 5000) {
                showAlert('advanceAlert', 'Le montant doit être entre 1€ et 5000€', 'danger');
                return;
            }
            
            if (!deductionMonth) {
                showAlert('advanceAlert', 'Erreur: mois de déduction non défini', 'danger');
                return;
            }
            
            // Afficher le loading
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'flex';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/advance-requests`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('employeeToken')}`
                    },
                    body: JSON.stringify({
                        amount,
                        deductionMonth
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('advanceAlert', '✅ Demande d\'acompte envoyée avec succès ! Vous recevrez une confirmation par email.', 'success');
                    
                    // Vider le formulaire
                    e.target.reset();
                    
                    // Fermer le modal après 2 secondes
                    setTimeout(() => {
                        closeAdvanceModal();
                    }, 2000);
                    
                } else {
                    showAlert('advanceAlert', `❌ ${data.message || 'Erreur lors de l\'envoi de la demande'}`, 'danger');
                }
                
            } catch (error) {
                console.error('Erreur demande acompte:', error);
                showAlert('advanceAlert', '❌ Erreur de connexion. Veuillez réessayer.', 'danger');
            } finally {
                // Restaurer le bouton
                btnText.style.display = 'block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Fonction pour activer l'onglet acompte (appelée par l'admin)
        // Note: Cette fonction n'est plus utilisée car l'affichage est maintenant géré par le paramètre
        function enableAdvanceTab() {
            const advanceTab = document.getElementById('advance-tab');
            if (advanceTab) {
                advanceTab.style.display = 'block';
                // Masquer l'onglet après 24h
                setTimeout(() => {
                    advanceTab.style.display = 'none';
                }, 24 * 60 * 60 * 1000); // 24 heures
            }
        }
    </script>
</body>
</html>
